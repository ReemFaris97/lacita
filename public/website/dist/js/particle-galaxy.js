var cos=Math.cos,sin=Math.sin,sqrt=Math.sqrt,abs=Math.abs,atan2=Math.atan2,log=Math.log,random=Math.random,PI=Math.PI,sqr=function(t){return t*t},particles=[],drawScale=1,emitters=[],forces=[],collidedMass=0,maxParticles=100,emissionRate=1;function Vector(t,s,i){this.x=t||0,this.y=s||0,this.z=i||0}function Particle(t,s,i,e){this.pos=t||new Vector(0,0),this.vc=s||new Vector(0,0),this.ac=i||new Vector(0,0),this.mass=e||1,this.alive=!0}function ParticleEmitter(t,s,i){this.pos=t,this.vc=s,this.ang=i||.09,this.color="#999"}function Force(t,s){this.pos=t,this.mass=s||100}function G(t){return.00674*t}Vector.prototype={add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},subtract:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},multiply:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this},magnitude:function(){return sqrt(sqr(this.x+this.y))},distance:function(t){return abs(sqrt(sqr(this.x-t.x)+sqr(this.y-t.y)))},angle:function(t,s){return t&&s?Vector.fromAngle(t,s):atan2(this.y,this.x)},clone:function(){return new Vector(this.x,this.y,this.z)},equals:function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},random:function(t){return this.x+=random()*t*2-t,this.y+=random()*t*2-t,this}},Vector.fromAngle=function(t,s){return new Vector(s*cos(t),s*sin(t),s*sin(t))},Particle.prototype.move=function(){this.vc.add(this.ac),this.pos.add(this.vc)},Particle.prototype.reactToForces=function(t){for(var s=0,i=0,e=0;e<t.length;e++){var a=(o=t[e]).pos.x-this.pos.x,r=o.pos.y-this.pos.y;(n=this.pos.distance(o.pos))<1&&o.grow(this),n<100&&(this.doubleSize=!0),s+=a*(c=G(this.forceBetween(o,n))),i+=r*c}this.ac=new Vector(s,i),s=0,i=0;for(e=0;e<particles.length;e++){var o;if((o=particles[e])!==this&&o.alive){var n;a=o.pos.x-this.pos.x,r=o.pos.y-this.pos.y;if((n=this.pos.distance(o.pos))<1)if(this.mass>=o.mass){this.mass,o.mass;particles.length<=maxParticles&&this.mass>40?(this.alive=!1,this.nova=!0,collidedMass+=this.mass):this.grow(o)}else this.alive=!1;if(this.alive){var c=G(this.forceBetween(o,n));s+=a*G(c),i+=r*G(c)}}}var h=this.pos.distance(this.lastPos?this.lastPos:this.pos);this.velocity=h-(this.lastDistance?this.lastDistance:h),this.lastDistance=h,this.lastPos=this.pos.clone(),this.ac.add(new Vector(s,i)),this.lastPos=this.pos.clone()},Particle.prototype.grow=function(t){this.mass+=t.mass,this.nova=!0,t.alive=!1,delete this.size},Particle.prototype.breakApart=function(t,s){t||(t=1),s||(s=2);for(var i=this.mass,e=0;i>0;){var a=new Particle(this.pos.clone().random(this.mass),new Vector(0,0));a.mass=1+Math.random()*(i-1),e>=s-1&&(a.mass=i),a.mass=a.mass<t?t:a.mass,i-=a.mass,e++}this.nova=!0,delete this.size,this.alive=!1},Particle.prototype.forceBetween=function(t,s){s=s||this.pos.distance(t.pos);return this.mass*t.mass/sqr(s)},ParticleEmitter.prototype.emit=function(){var t=this.vc.angle()+this.ang-Math.random()*this.ang*2,s=this.vc.magnitude(),i=this.pos.clone();return i.add(new Vector(~~(100*Math.random()-50)*drawScale,~~(100*Math.random()-50)*drawScale)),new Particle(i,Vector.fromAngle(t,s))},Force.prototype.grow=function(t){this.mass+=t.mass,this.burp=!0,t.alive=!1};var canvas=document.querySelector("#scene"),ctx=canvas.getContext("2d");canvas.width=window.innerWidth,canvas.height=window.innerHeight;var canvasWidth=canvas.width,canvasHeight=canvas.height,renderToCanvas=function(t,s,i){var e=document.createElement("canvas");return e.width=t,e.height=s,i(e.getContext("2d")),e};function loop(){clear(),update(),draw(),queue()}function clear(){ctx.clearRect(0,0,canvas.width,canvas.height)}maxParticles=500,emissionRate=1,drawScale=1.3,minParticleSize=2,emitters=[new ParticleEmitter(new Vector(canvasWidth/2*drawScale+400,canvasHeight/2*drawScale),Vector.fromAngle(2,5),1),new ParticleEmitter(new Vector(canvasWidth/2*drawScale-400,canvasHeight/2*drawScale),Vector.fromAngle(5,5),1)],forces=[new Force(new Vector(canvasWidth/2*drawScale,canvasHeight/2*drawScale),1800)];var ctr=0,c=["rgba(255,255,255,","rgba(0,150,255,","rgba(255,255,128,","rgba(255,255,255,"];function rndc(){return c[~~(Math.random()*c.length-1)]}var c2="rgba(255,64,32,";function addNewParticles(){var t=function(){for(var t=0,s=0;s<emitters.length;s++)for(var i=0;i<emissionRate;i++){var e=emitters[s].emit();e.color=ctr%10==0&&5*Math.random()<=1?c2:rndc(),e.mass=~~(5*Math.random()),particles.push(e),t+=e.mass,ctr++}return t};if(0!==collidedMass)for(;0!==collidedMass;)collidedMass=(collidedMass-=t())<0?0:collidedMass;particles.length>maxParticles||t()}var CLIPOFFSCREEN=1,BUFFEROFFSCREEN=2,LOOPSCREEN=3;function isPositionAliveAndAdjust(t,s){return!0}function plotParticles(t,s){for(var i=[],e=0;e<particles.length;e++){var a=particles[e];a.reactToForces(forces),isPositionAliveAndAdjust(a)&&(a.move(),i.push(a))}}var offscreenCache={};function renderParticle(t){t.pos;t.size||(t.size=Math.floor(t.mass/100)),t.opacity||(t.opacity=.05),t.velocity>0&&t.opacity<=.18&&(t.opacity+=.04),t.opacity>.08&&(t.opacity-=.02);var s=t.size/drawScale;s=s<minParticleSize?minParticleSize:s,t.mass>8&&(s*=2),t.nova&&(s*=4,t.nova=!1),t.doubleSize&&(t.doubleSize=!1,s*=2);var i=s+"_"+t.opacity+"_"+t.color,e=offscreenCache[i];e||(e=renderToCanvas(32*s,32*s,function(i){var e=t.opacity,a=[{size:s/2,opacity:1},{size:s,opacity:e},{size:2*s,opacity:e/2},{size:4*s,opacity:e/3},{size:8*s,opacity:e/5},{size:16*s,opacity:e/16}];for(var r in i.beginPath(),a)r=a[r],i.fillStyle=t.color+r.opacity+")",i.arc(16*s,16*s,r.size,0,2*Math.PI,!0),i.fill();i.closePath()}),offscreenCache[i]=e);var a=t.pos.x/drawScale,r=t.pos.y/drawScale;ctx.drawImage(e,a,r)}var fills=[{size:15,opacity:1},{size:25,opacity:.3},{size:50,opacity:.1}];function renderScene(t){for(var s=0;s<forces.length;s++){(e=forces[s]).pos;for(var i in t.beginPath(),fills){i=fills[i];!0===e.burp||i.opacity;e.burp=!1}t.closePath()}for(s=0;s<particles.length;s++){var e;renderParticle(e=particles[s])}}function draw(){renderScene(ctx)}function update(){addNewParticles(),plotParticles(canvas.width,canvas.height)}function queue(){window.requestAnimationFrame(loop)}$("canvas").mousedown(function(t){}),$("canvas").mouseup(function(t){}),loop();